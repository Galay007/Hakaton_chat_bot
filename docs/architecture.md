# Архитектура Telegram Export Participants Bot

## 1. Общая схема
```
Telegram User -> Telegram API -> BotHandler -> FileManager -> DataParser
                                                    |
                                                    v
                                              DataProcessor -> SessionData -> ExcelGenerator
```

1. Пользователь отправляет один или несколько файлов экспорта в чат с ботом.
2. `BotHandler` получает `Document`-апдейт и проверяет лимиты сессии.
3. `FileManager` скачивает файл целиком в оперативную память (без записи на диск).
4. `DataParser` определяет формат (JSON) и извлекает:
   - список уникальных авторов сообщений;
   - упомянутые `@username`;
   - потенциальные каналы (`t.me/...`).
5. `SessionData` агрегирует данные по пользователю, выполняя дедупликацию и фильтрацию удалённых аккаунтов.
6. По команде `/export` бот либо присылает текстовый список (до 50 участников), либо генерирует Excel через `ExcelGenerator`.

## 2. Модули
| Модуль | Детали                                                                                                                      |
|--------|-----------------------------------------------------------------------------------------------------------------------------|
| `bot_handler.py` | Telegram-команды (`/start`, `/help`, `/reset`, `/export`). Логика лимитов и UX.                                             |
| `file_manager.py` | Строгое ограничение форматов, загрузка файла в `bytes`. Позволяет избежать временных файлов на диске.                       |
| `data_parser.py` | Один парсер: JSON (через `json`). Используются регулярные выражения для поиска `@` и `t.me`. |
| `models.py` | `IdentityRecord`, `ParsedData`, `SessionData`. Дедупликация по комбинации username/ID.                                      |
| `excel_generator.py` | Создаёт Excel с тремя вкладками. Используются фиксированные столбцы, как требует бриф.                                      |
| `main.py` + `config.py` | Точка входа, загрузка окружения, настройка логирования.                                                                     |

## 3. Безопасность и конфиденциальность
- Файлы загружаются в память (`bytes`) и не сохраняются на диск. После парсинга объект `bytes` подлежит сборке мусора.
- Сессия привязана к `user_id` и очищается после выдачи результата или по `/reset`.
- Docker-образ не использует тома, поэтому данные не остаются между рестартами.
- Excel-файл формируется в `BytesIO` и сразу отправляется пользователю.

## 4. Масштабирование
- Потоки зависимы от Telegram API (Long Polling). При необходимости можно переключиться на Webhook, не меняя остальную часть кода.
- Для горизонтального масштабирования каждая реплика бота в Docker может работать независимо; состояние пользователей полностью в памяти, поэтому требуется привязка к конкретной реплике (или хранение в Redis, если потребуется).
- Порог обработки (>50 участников) вынесен в конфиг, так что бизнес-логику легко изменить.

## 5. Ограничения
- Качество данных зависит от полноты Telegram-экспорта. Поле «Описание» и «Дата регистрации» часто отсутствуют — в таких случаях бот выводит `Неизвестно`.
- Детерминированность каналов строится на эвристиках (`t.me/slug`). Для высокого качества можно дополнить справочником или запросами к Telegram API (необязательно в рамках задачи).

## 6. Будущие улучшения
- Добавить хранение выполняющихся задач в очереди (например, `rq`), если размер файлов значительно вырастет.
- Поддержка ZIP-архивов экспорта (распаковка в памяти).
- Интеграция с облачным сториджем для временных файлов (с автозатиранием) при больших объёмах.
